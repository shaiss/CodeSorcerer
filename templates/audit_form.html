{% extends "base.html" %}

{% block title %}Start New Audit - NEAR Hackathon Auditor{% endblock %}

{% block extra_head %}
<style>
    .validation-results {
        display: none;
        margin-top: 1rem;
    }
    .file-list {
        max-height: 300px;
        overflow-y: auto;
    }
    .directory-item {
        cursor: pointer;
    }
    .directory-item:hover {
        background-color: rgba(0,0,0,0.05);
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h2>Start New Audit</h2>
            </div>
            <div class="card-body">
                <form method="post" action="{{ url_for('audit') }}">
                    <div class="mb-3">
                        <label for="repo_path" class="form-label">Repository Path or GitHub URL</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-code-square" id="inputTypeIcon"></i>
                            </span>
                            <input type="text" class="form-control" id="repo_path" name="repo_path" 
                                   placeholder="e.g., /path/to/repository or https://github.com/username/repo" required>
                            <button class="btn btn-outline-secondary" type="button" 
                                    data-bs-toggle="modal" data-bs-target="#fileExplorerModal" id="browseButton">
                                Browse
                            </button>
                        </div>
                        <div class="form-text" id="repoPathHelp">
                            You can enter either a local repository path or a GitHub repository URL.
                            <span class="badge bg-info ms-1">New!</span>
                        </div>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="radio" name="repoType" id="localRepoType" value="local" checked>
                            <label class="form-check-label" for="localRepoType">
                                Local Repository
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="repoType" id="githubRepoType" value="github">
                            <label class="form-check-label" for="githubRepoType">
                                GitHub Repository URL
                            </label>
                        </div>
                    </div>
                    
                    {% if sample_repos %}
                    <div class="mb-3">
                        <label for="sample_repo" class="form-label">Sample Repositories</label>
                        <select class="form-select" id="sample_repo" onchange="selectSampleRepo()">
                            <option value="" selected>-- Select a sample repository --</option>
                            {% for repo in sample_repos %}
                            <option value="{{ repo }}">{{ repo }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">You can select from these pre-configured test repositories</div>
                    </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        <label for="branch" class="form-label">Branch</label>
                        <input type="text" class="form-control" id="branch" name="branch" 
                               value="main" placeholder="e.g., main, master, develop">
                        <div class="form-text">The branch to audit (usually 'main' or 'master')</div>
                    </div>
                    
                    <div class="form-text mb-3">
                        <div class="alert alert-info">
                            <strong>Important:</strong> The audit process may take several minutes depending on the repository size.
                            This tool requires an OpenAI API key set in the environment variables.
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <button type="button" id="validateBtn" class="btn btn-outline-secondary me-2" onclick="validateRepository()">Validate Repository</button>
                        <button type="submit" class="btn btn-primary">Start Audit</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h3>Audit Process</h3>
            </div>
            <div class="card-body">
                <p>The audit tool will analyze the repository across 7 categories:</p>
                <ul class="list-group mb-3">
                    <li class="list-group-item">Code Quality (10 points)</li>
                    <li class="list-group-item">Functionality (10 points)</li>
                    <li class="list-group-item">Security (10 points)</li>
                    <li class="list-group-item">Innovation (10 points)</li>
                    <li class="list-group-item">Documentation (10 points)</li>
                    <li class="list-group-item">UX Design (10 points)</li>
                    <li class="list-group-item">Blockchain Integration (10 points)</li>
                </ul>
                <p>Each category is scored from 0-10 based on specific criteria, with detailed feedback provided.</p>
            </div>
        </div>
        
        <!-- Validation Results Card -->
        <div id="validationResults" class="card mt-4 validation-results">
            <div class="card-header">
                <h3>Repository Validation</h3>
            </div>
            <div class="card-body">
                <div id="validationSpinner" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Validating repository...</p>
                </div>
                <div id="validationContent" style="display: none;">
                    <div id="validationStatus" class="alert mb-3"></div>
                    
                    <h4>Repository Statistics</h4>
                    <table class="table table-sm">
                        <tr>
                            <th>Total Files:</th>
                            <td id="totalFiles">-</td>
                            <th>Code Files:</th>
                            <td id="codeFiles">-</td>
                        </tr>
                        <tr>
                            <th>Doc Files:</th>
                            <td id="docFiles">-</td>
                            <th>Other Files:</th>
                            <td id="otherFiles">-</td>
                        </tr>
                    </table>
                    
                    <h4>Top File Types</h4>
                    <div id="fileTypes"></div>
                    
                    <div class="mt-3">
                        <button class="btn btn-sm btn-outline-primary local-repo-only" type="button" onclick="viewDirectoryStructure()">
                            View Directory Structure
                        </button>
                        <a id="debugRepoBtn" href="/debug-repository" class="btn btn-sm btn-outline-secondary ms-2 local-repo-only">
                            Detailed Debug Info
                        </a>
                    </div>
                    
                    <div id="directoryStructure" class="mt-3 local-repo-only" style="display: none;">
                        <h4>Directory Structure</h4>
                        <div id="dirList" class="list-group file-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- File Explorer Modal -->
<div class="modal fade" id="fileExplorerModal" tabindex="-1" aria-labelledby="fileExplorerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fileExplorerModalLabel">Select Repository Directory</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="currentPath" class="mb-2 p-2 bg-light">
                    <code id="currentPathText">/</code>
                </div>
                <div id="fileList" class="list-group file-list">
                    <!-- Directory list will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="selectCurrentDir()">Select This Directory</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize repository type toggle
    document.addEventListener('DOMContentLoaded', function() {
        // Set up event listeners for repo type radio buttons
        document.getElementById('localRepoType').addEventListener('change', updateRepoTypeUI);
        document.getElementById('githubRepoType').addEventListener('change', updateRepoTypeUI);
        
        // Initial UI setup
        updateRepoTypeUI();
        
        // Also detect GitHub URLs automatically
        document.getElementById('repo_path').addEventListener('input', detectRepoType);
    });
    
    // Update UI based on selected repository type
    function updateRepoTypeUI() {
        const isLocal = document.getElementById('localRepoType').checked;
        const repoPath = document.getElementById('repo_path');
        const browseButton = document.getElementById('browseButton');
        const inputTypeIcon = document.getElementById('inputTypeIcon');
        const repoPathHelp = document.getElementById('repoPathHelp');
        
        if (isLocal) {
            // Local repository mode
            repoPath.placeholder = 'e.g., /path/to/repository';
            browseButton.style.display = '';
            inputTypeIcon.className = 'bi bi-folder';
            repoPathHelp.innerHTML = 'Enter the absolute path to a local repository to audit.';
        } else {
            // GitHub repository mode
            repoPath.placeholder = 'e.g., https://github.com/username/repo';
            browseButton.style.display = 'none';
            inputTypeIcon.className = 'bi bi-github';
            repoPathHelp.innerHTML = 'Enter a GitHub repository URL (https://github.com/username/repo). <span class="badge bg-info ms-1">New!</span>';
        }
    }
    
    // Auto-detect repository type based on input
    function detectRepoType() {
        const repoPath = document.getElementById('repo_path').value.trim();
        const githubPattern = /^https?:\/\/github\.com\/[\w-]+\/[\w.-]+\/?(?:\.git)?$/;
        
        if (githubPattern.test(repoPath) || repoPath.startsWith('git@github.com:')) {
            // This looks like a GitHub URL, select GitHub mode
            document.getElementById('githubRepoType').checked = true;
            updateRepoTypeUI();
        } else if (repoPath.startsWith('/') || repoPath.includes(':\\') || repoPath.startsWith('~')) {
            // This looks like a file path, select local mode
            document.getElementById('localRepoType').checked = true;
            updateRepoTypeUI();
        }
    }
    
    // Sample repository selection
    function selectSampleRepo() {
        const select = document.getElementById('sample_repo');
        const repoPath = document.getElementById('repo_path');
        
        if (select.value) {
            repoPath.value = select.value;
            // Select local repo type since samples are local
            document.getElementById('localRepoType').checked = true;
            updateRepoTypeUI();
            // Auto-validate when selecting a sample repo
            validateRepository();
        }
    }
    
    // Repository validation
    function validateRepository() {
        const repoPath = document.getElementById('repo_path').value;
        
        if (!repoPath) {
            alert('Please enter a repository path or GitHub URL');
            return;
        }
        
        // Show validation results area and spinner
        document.getElementById('validationResults').style.display = 'block';
        document.getElementById('validationSpinner').style.display = 'block';
        document.getElementById('validationContent').style.display = 'none';
        
        // Make an AJAX call to validate the repository
        fetch('/validate-repository?path=' + encodeURIComponent(repoPath))
            .then(response => response.json())
            .then(data => {
                document.getElementById('validationSpinner').style.display = 'none';
                document.getElementById('validationContent').style.display = 'block';
                
                if (data.valid) {
                    document.getElementById('validationStatus').className = 'alert alert-success mb-3';
                    
                    if (data.is_github_url) {
                        // GitHub repository
                        document.getElementById('validationStatus').innerHTML = 
                            '<strong>Success!</strong> ' + data.message;
                        
                        // Display GitHub-specific info
                        document.getElementById('totalFiles').textContent = data.stats.total_files;
                        document.getElementById('codeFiles').textContent = data.stats.code_files;
                        document.getElementById('docFiles').textContent = data.stats.doc_files;
                        document.getElementById('otherFiles').textContent = data.stats.other_files;
                        
                        // Disable directory structure and debug buttons for GitHub repos
                        document.querySelectorAll('.local-repo-only').forEach(el => {
                            el.style.display = 'none';
                        });
                    } else {
                        // Local repository
                        document.getElementById('validationStatus').innerHTML = 
                            '<strong>Success!</strong> ' + data.message;
                        
                        // Populate stats
                        document.getElementById('totalFiles').textContent = data.stats.total_files;
                        document.getElementById('codeFiles').textContent = data.stats.code_files;
                        document.getElementById('docFiles').textContent = data.stats.doc_files;
                        document.getElementById('otherFiles').textContent = data.stats.other_files;
                        
                        // Re-enable local repo specific elements
                        document.querySelectorAll('.local-repo-only').forEach(el => {
                            el.style.display = '';
                        });
                    }
                    
                    // Populate file types
                    const fileTypesDiv = document.getElementById('fileTypes');
                    fileTypesDiv.innerHTML = '';
                    
                    Object.entries(data.stats.file_types).forEach(([ext, count]) => {
                        const badge = document.createElement('span');
                        badge.className = 'badge bg-primary me-1 mb-1';
                        badge.textContent = `${ext} (${count})`;
                        fileTypesDiv.appendChild(badge);
                    });
                    
                    // Update debug repo button
                    document.getElementById('debugRepoBtn').href = '/debug-repository';
                } else {
                    document.getElementById('validationStatus').className = 'alert alert-danger mb-3';
                    document.getElementById('validationStatus').innerHTML = 
                        '<strong>Error:</strong> ' + data.message;
                }
            })
            .catch(error => {
                document.getElementById('validationSpinner').style.display = 'none';
                document.getElementById('validationContent').style.display = 'block';
                document.getElementById('validationStatus').className = 'alert alert-danger mb-3';
                document.getElementById('validationStatus').innerHTML = 
                    '<strong>Error:</strong> Failed to validate repository: ' + error;
            });
    }
    
    // Display directory structure
    function viewDirectoryStructure() {
        const dirStructure = document.getElementById('directoryStructure');
        const dirList = document.getElementById('dirList');
        const repoPath = document.getElementById('repo_path').value;
        
        if (dirStructure.style.display === 'none') {
            dirStructure.style.display = 'block';
            
            // Make AJAX call to get directory structure
            fetch('/repository-structure?path=' + encodeURIComponent(repoPath))
                .then(response => response.json())
                .then(data => {
                    dirList.innerHTML = '';
                    
                    if (data.directories && data.directories.length > 0) {
                        data.directories.forEach(dir => {
                            const item = document.createElement('div');
                            item.className = 'list-group-item directory-item';
                            item.innerHTML = `<i class="bi bi-folder-fill me-2"></i>${dir}`;
                            dirList.appendChild(item);
                        });
                    } else {
                        dirList.innerHTML = '<div class="list-group-item">No directories found</div>';
                    }
                })
                .catch(error => {
                    dirList.innerHTML = `<div class="list-group-item text-danger">
                        Error loading directory structure: ${error}
                    </div>`;
                });
        } else {
            dirStructure.style.display = 'none';
        }
    }
    
    // File explorer functionality
    let currentDirectory = '/';
    
    function updateFileList(directory) {
        // Make AJAX call to get directory contents
        fetch('/directory-contents?path=' + encodeURIComponent(directory))
            .then(response => response.json())
            .then(data => {
                const fileList = document.getElementById('fileList');
                fileList.innerHTML = '';
                
                // Add parent directory option if not at root
                if (directory !== '/') {
                    const parentDir = directory.substring(0, directory.lastIndexOf('/'));
                    const parentPath = parentDir || '/';
                    
                    const item = document.createElement('div');
                    item.className = 'list-group-item directory-item';
                    item.innerHTML = '<i class="bi bi-arrow-up-circle me-2"></i>..';
                    item.onclick = () => navigateTo(parentPath);
                    fileList.appendChild(item);
                }
                
                // Add directories
                if (data.directories && data.directories.length > 0) {
                    data.directories.forEach(dir => {
                        const item = document.createElement('div');
                        item.className = 'list-group-item directory-item';
                        item.innerHTML = `<i class="bi bi-folder-fill me-2"></i>${dir}`;
                        item.onclick = () => navigateTo(`${directory === '/' ? '' : directory}/${dir}`);
                        fileList.appendChild(item);
                    });
                } else {
                    fileList.innerHTML += '<div class="list-group-item">No directories found</div>';
                }
            })
            .catch(error => {
                const fileList = document.getElementById('fileList');
                fileList.innerHTML = `<div class="list-group-item text-danger">
                    Error loading directory contents: ${error}
                </div>`;
            });
    }
    
    function navigateTo(directory) {
        currentDirectory = directory;
        document.getElementById('currentPathText').textContent = directory;
        updateFileList(directory);
    }
    
    function selectCurrentDir() {
        document.getElementById('repo_path').value = currentDirectory;
        const modal = bootstrap.Modal.getInstance(document.getElementById('fileExplorerModal'));
        modal.hide();
        // Auto-validate after selection
        validateRepository();
    }
    
    // Initialize file explorer when modal is shown
    document.getElementById('fileExplorerModal').addEventListener('show.bs.modal', function (event) {
        navigateTo('/');
    });
</script>
{% endblock %}